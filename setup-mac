#!/bin/bash
set -e

# Enforce that all updates are installed before we begin
function check_macos_updated() {
  echo "Checking if macOS is up to date..."
  if [[ "$(sudo softwareupdate -l 2>&1)" != *"No new software available"* ]]; then
    echo "Updating macOS"
    sudo softwareupdate -i -a
    echo "Reboot your machine now and run this script again afterwards."
    exit 0
  else
    echo "This macOS is up to date."
  fi
}

# Install brew and XCode Command Line Tools
function install_brew() {
  if ! command -v brew > /dev/null 2>&1; then
    echo "Installing Brew..."
    printf "\n\n" | ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
    brew analytics off
  else
    echo "Brew already installed."
  fi
}

function install_dotfiles() {
  mkdir -p ~/code
  cd ~/code
  if [ ! -d ~/code/dotfiles ]; then
    echo "Cloning dotfiles repo"
    git clone https://github.com/StefanScherer/dotfiles
  else
    echo "Updating dotfiles repo"
  fi
  cd ~/code/dotfiles
  ./sync.sh -f
}

function install_brew_packages() {
  echo "Install new taps from brew.txt"
  comm -23 \
    <(sort ~/code/dotfiles/brew.txt) \
    <(brew ls --full-name) \
    | xargs brew install
  
  echo "Install new casks from cask.txt"
  comm -23 \
    <(sort ~/code/dotfiles/cask.txt) \
    <(brew cask ls) \
    | xargs brew cask install
}


function install_solarized_profiles() {
  if [ "$(defaults read com.apple.Terminal 'Default Window Settings')" != "Solarized Light xterm-256color" ]; then
    # convert hex string from "defaults read" into base64
    # echo "my hex string" | echo -n -e $(tr -d '[:space:]' | sed 's/../\\x&/g') | base64
    defaults write com.apple.Terminal "Window Settings" -dict-add "Solarized Dark xterm-256color" '<dict><key>BackgroundColor</key><data>YnBsaXN0MDDUAQIDBAUGFRZYJHZlcnNpb25YJG9iamVjdHNZJGFyY2hpdmVyVCR0b3ASAAGGoKMHCA9VJG51bGzTCQoLDA0OVU5TUkdCXE5TQ29sb3JTcGFjZVYkY2xhc3NPECgwLjAxNTkyNDQwNTMxIDAuMTI2NTIwOTE2OCAwLjE1OTY5NjAxMjcAEAGAAtIQERITWiRjbGFzc25hbWVYJGNsYXNzZXNXTlNDb2xvcqISFFhOU09iamVjdF8QD05TS2V5ZWRBcmNoaXZlctEXGFRyb290gAEIERojLTI3O0FITltijY+RlqGqsrW+0NPYAAAAAAAAAQEAAAAAAAAAGQAAAAAAAAAAAAAAAAAAANo=</data><key>BlinkText</key><false/><key>CursorColor</key><data>YnBsaXN0MDDUAQIDBAUGFRZYJHZlcnNpb25YJG9iamVjdHNZJGFyY2hpdmVyVCR0b3ASAAGGoKMHCA9VJG51bGzTCQoLDA0OViRjbGFzc1xOU0NvbG9yU3BhY2VVTlNSR0KAAhABTxAnMC40NDA1ODAyNDg4IDAuNTA5NjI5MzA5MiAwLjUxNjg1Nzk4MTcA0hAREhNaJGNsYXNzbmFtZVgkY2xhc3Nlc1dOU0NvbG9yohIUWE5TT2JqZWN0XxAPTlNLZXllZEFyY2hpdmVy0RcYVHJvb3SAAQgRGiMtMjc7QUhPXGJkZpCVoKmxtL3P0tcAAAAAAAABAQAAAAAAAAAZAAAAAAAAAAAAAAAAAAAA2Q==</data><key>Font</key><data>YnBsaXN0MDDUAQIDBAUGGBlYJHZlcnNpb25YJG9iamVjdHNZJGFyY2hpdmVyVCR0b3ASAAGGoKQHCBESVSRudWxs1AkKCwwNDg8QViRjbGFzc1ZOU05hbWVWTlNTaXplWE5TZkZsYWdzgAOAAiNAJgAAAAAAABAQXU1lbmxvLVJlZ3VsYXLSExQVFlokY2xhc3NuYW1lWCRjbGFzc2VzVk5TRm9udKIVF1hOU09iamVjdF8QD05TS2V5ZWRBcmNoaXZlctEaG1Ryb290gAEIERojLTI3PEJLUllgaWttdniGi5afpqmyxMfMAAAAAAAAAQEAAAAAAAAAHAAAAAAAAAAAAAAAAAAAAM4=</data><key>FontAntialias</key><true/><key>FontWidthSpacing</key><real>1.004032258064516</real><key>ProfileCurrentVersion</key><real>2.0099999999999998</real><key>SelectionColor</key><data>YnBsaXN0MDDUAQIDBAUGFRZYJHZlcnNpb25YJG9iamVjdHNZJGFyY2hpdmVyVCR0b3ASAAGGoKMHCA9VJG51bGzTCQoLDA0OViRjbGFzc1xOU0NvbG9yU3BhY2VVTlNSR0KAAhABTxAoMC4wMzkzODA3MzY2NSAwLjE2MDExNjQ2MzkgMC4xOTgzMzI3NTY4ANIQERITWiRjbGFzc25hbWVYJGNsYXNzZXNXTlNDb2xvcqISFFhOU09iamVjdF8QD05TS2V5ZWRBcmNoaXZlctEXGFRyb290gAEIERojLTI3O0FIT1xiZGaRlqGqsrW+0NPYAAAAAAAAAQEAAAAAAAAAGQAAAAAAAAAAAAAAAAAAANo=</data><key>ShowWindowSettingsNameInTitle</key><true/><key>TerminalType</key><string>xterm-256color</string><key>TextBoldColor</key><data>YnBsaXN0MDDUAQIDBAUGFRZYJHZlcnNpb25YJG9iamVjdHNZJGFyY2hpdmVyVCR0b3ASAAGGoKMHCA9VJG51bGzTCQoLDA0OViRjbGFzc1xOU0NvbG9yU3BhY2VVTlNSR0KAAhABTxAmMC41MDU5OTE5MzU3IDAuNTY0ODU4Mzc3IDAuNTYzNjM2NTQxNADSEBESE1okY2xhc3NuYW1lWCRjbGFzc2VzV05TQ29sb3KiEhRYTlNPYmplY3RfEA9OU0tleWVkQXJjaGl2ZXLRFxhUcm9vdIABCBEaIy0yNztBSE9cYmRmj5SfqLCzvM7R1gAAAAAAAAEBAAAAAAAAABkAAAAAAAAAAAAAAAAAAADY</data><key>TextColor</key><data>YnBsaXN0MDDUAQIDBAUGFRZYJHZlcnNpb25YJG9iamVjdHNZJGFyY2hpdmVyVCR0b3ASAAGGoKMHCA9VJG51bGzTCQoLDA0OViRjbGFzc1xOU0NvbG9yU3BhY2VVTlNSR0KAAhABTxAnMC40NDA1ODAyNDg4IDAuNTA5NjI5MzA5MiAwLjUxNjg1Nzk4MTcA0hAREhNaJGNsYXNzbmFtZVgkY2xhc3Nlc1dOU0NvbG9yohIUWE5TT2JqZWN0XxAPTlNLZXllZEFyY2hpdmVy0RcYVHJvb3SAAQgRGiMtMjc7QUhPXGJkZpCVoKmxtL3P0tcAAAAAAAABAQAAAAAAAAAZAAAAAAAAAAAAAAAAAAAA2Q==</data><key>UseBrightBold</key><true/><key>blackColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg7JNIT2DkvUjPoO+F0s+AYY=</data><key>blueColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmgyqcAj6DtOHsPoO+RUg/AYY=</data><key>brightBlackColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg+ZzgjyDs44BPoNahyM+AYY=</data><key>brightBlueColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg7yT4T6DEXcCP4POUAQ/AYY=</data><key>brightCyanColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg7CIAT+Dj5oQP4N8ShA/AYY=</data><key>brightGreenColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmgzyujT6DFZy2PoOYFsQ+AYY=</data><key>brightMagentaColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmgxMjsj6D+uazPoNkyTc/AYY=</data><key>brightRedColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmgyfkPT+D/15aPoMgl5Y9AYY=</data><key>brightWhiteColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg49LfT+D0Dt1P4MGM10/AYY=</data><key>brightYellowColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg1MTpj6DeHnQPoPQg+A+AYY=</data><key>cyanColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg4VRFj6DfyESP4PkZwY/AYY=</data><key>greenColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg9lI5j6DIYkKP4PVjKU8AYY=</data><key>magentaColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg/4CRz+DBTzdPYMgzt4+AYY=</data><key>name</key><string>Solarized Dark xterm-256color</string><key>redColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg6i7UT+DUATePYMl2hA+AYY=</data><key>type</key><string>Window Settings</string><key>whiteColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmgzqGaj+D2tdjP4NYPUw/AYY=</data><key>yellowColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg0DAJT+DB17vPoM4Y8A8AYY=</data></dict>'
    defaults write com.apple.Terminal "Window Settings" -dict-add "Solarized Light xterm-256color" '<dict><key>BackgroundColor</key><data>YnBsaXN0MDDUAQIDBAUGFRZYJHZlcnNpb25YJG9iamVjdHNZJGFyY2hpdmVyVCR0b3ASAAGGoKMHCA9VJG51bGzTCQoLDA0OVU5TUkdCXE5TQ29sb3JTcGFjZVYkY2xhc3NPECcwLjk4OTQzNDE4MjYgMC45NTc5NDM5MTYzIDAuODY0MDU5ODA1OQAQAYAC0hAREhNaJGNsYXNzbmFtZVgkY2xhc3Nlc1dOU0NvbG9yohIUWE5TT2JqZWN0XxAPTlNLZXllZEFyY2hpdmVy0RcYVHJvb3SAAQgRGiMtMjc7QUhOW2KMjpCVoKmxtL3P0tcAAAAAAAABAQAAAAAAAAAZAAAAAAAAAAAAAAAAAAAA2Q==</data><key>BlinkText</key><false/><key>CommandString</key><string></string><key>CursorColor</key><data>YnBsaXN0MDDUAQIDBAUGFRZYJHZlcnNpb25YJG9iamVjdHNZJGFyY2hpdmVyVCR0b3ASAAGGoKMHCA9VJG51bGzTCQoLDA0OViRjbGFzc1xOU0NvbG9yU3BhY2VVTlNSR0KAAhABTxAmMC4zMjQzNjYxODIxIDAuNDA3MTc2NzMzIDAuNDM4NTA1NjQ5NgDSEBESE1okY2xhc3NuYW1lWCRjbGFzc2VzV05TQ29sb3KiEhRYTlNPYmplY3RfEA9OU0tleWVkQXJjaGl2ZXLRFxhUcm9vdIABCBEaIy0yNztBSE9cYmRmj5SfqLCzvM7R1gAAAAAAAAEBAAAAAAAAABkAAAAAAAAAAAAAAAAAAADY</data><key>Font</key><data>YnBsaXN0MDDUAQIDBAUGGBlYJHZlcnNpb25YJG9iamVjdHNZJGFyY2hpdmVyVCR0b3ASAAGGoKQHCBESVSRudWxs1AkKCwwNDg8QViRjbGFzc1ZOU05hbWVWTlNTaXplWE5TZkZsYWdzgAOAAiNAJgAAAAAAABAQXU1lbmxvLVJlZ3VsYXLSExQVFlokY2xhc3NuYW1lWCRjbGFzc2VzVk5TRm9udKIVF1hOU09iamVjdF8QD05TS2V5ZWRBcmNoaXZlctEaG1Ryb290gAEIERojLTI3PEJLUllgaWttdniGi5afpqmyxMfMAAAAAAAAAQEAAAAAAAAAHAAAAAAAAAAAAAAAAAAAAM4=</data><key>FontAntialias</key><true/><key>FontWidthSpacing</key><real>1.004032258064516</real><key>ProfileCurrentVersion</key><real>2.0099999999999998</real><key>RunCommandAsShell</key><true/><key>SelectionColor</key><data>YnBsaXN0MDDUAQIDBAUGFRZYJHZlcnNpb25YJG9iamVjdHNZJGFyY2hpdmVyVCR0b3ASAAGGoKMHCA9VJG51bGzTCQoLDA0OViRjbGFzc1xOU0NvbG9yU3BhY2VVTlNSR0KAAhABTxAnMC45MTYxMTA2MzQ4IDAuODkwMDEyMzgzNSAwLjc5NzgxMTAzMTMA0hAREhNaJGNsYXNzbmFtZVgkY2xhc3Nlc1dOU0NvbG9yohIUWE5TT2JqZWN0XxAPTlNLZXllZEFyY2hpdmVy0RcYVHJvb3SAAQgRGiMtMjc7QUhPXGJkZpCVoKmxtL3P0tcAAAAAAAABAQAAAAAAAAAZAAAAAAAAAAAAAAAAAAAA2Q==</data><key>TerminalType</key><string>xterm-256color</string><key>TextBoldColor</key><data>YnBsaXN0MDDUAQIDBAUGFRZYJHZlcnNpb25YJG9iamVjdHNZJGFyY2hpdmVyVCR0b3ASAAGGoKMHCA9VJG51bGzTCQoLDA0OViRjbGFzc1xOU0NvbG9yU3BhY2VVTlNSR0KAAhABTxAnMC4yNzY3MTk5Mjc4IDAuMzU2NjU5NTYxNCAwLjM4Mjk4NDg3NjYA0hAREhNaJGNsYXNzbmFtZVgkY2xhc3Nlc1dOU0NvbG9yohIUWE5TT2JqZWN0XxAPTlNLZXllZEFyY2hpdmVy0RcYVHJvb3SAAQgRGiMtMjc7QUhPXGJkZpCVoKmxtL3P0tcAAAAAAAABAQAAAAAAAAAZAAAAAAAAAAAAAAAAAAAA2Q==</data><key>TextColor</key><data>YnBsaXN0MDDUAQIDBAUGFRZYJHZlcnNpb25YJG9iamVjdHNZJGFyY2hpdmVyVCR0b3ASAAGGoKMHCA9VJG51bGzTCQoLDA0OViRjbGFzc1xOU0NvbG9yU3BhY2VVTlNSR0KAAhABTxAmMC4zMjQzNjYxODIxIDAuNDA3MTc2NzMzIDAuNDM4NTA1NjQ5NgDSEBESE1okY2xhc3NuYW1lWCRjbGFzc2VzV05TQ29sb3KiEhRYTlNPYmplY3RfEA9OU0tleWVkQXJjaGl2ZXLRFxhUcm9vdIABCBEaIy0yNztBSE9cYmRmj5SfqLCzvM7R1gAAAAAAAAEBAAAAAAAAABkAAAAAAAAAAAAAAAAAAADY</data><key>UseBrightBold</key><true/><key>blackColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg7JNIT2DkvUjPoO+F0s+AYY=</data><key>blueColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmgyqcAj6DtOHsPoO+RUg/AYY=</data><key>brightBlackColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg+ZzgjyDs44BPoNahyM+AYY=</data><key>brightBlueColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg7yT4T6DEXcCP4POUAQ/AYY=</data><key>brightCyanColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg7CIAT+Dj5oQP4N8ShA/AYY=</data><key>brightGreenColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmgzyujT6DFZy2PoOYFsQ+AYY=</data><key>brightMagentaColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmgxMjsj6D+uazPoNkyTc/AYY=</data><key>brightRedColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmgyfkPT+D/15aPoMgl5Y9AYY=</data><key>brightWhiteColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg49LfT+D0Dt1P4MGM10/AYY=</data><key>brightYellowColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg1MTpj6DeHnQPoPQg+A+AYY=</data><key>cyanColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg4VRFj6DfyESP4PkZwY/AYY=</data><key>greenColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg9lI5j6DIYkKP4PVjKU8AYY=</data><key>magentaColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg/4CRz+DBTzdPYMgzt4+AYY=</data><key>name</key><string>Solarized Light xterm-256color</string><key>redColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg6i7UT+DUATePYMl2hA+AYY=</data><key>type</key><string>Window Settings</string><key>whiteColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmgzqGaj+D2tdjP4NYPUw/AYY=</data><key>yellowColour</key><data>BAtzdHJlYW10eXBlZIHoA4QBQISEhAdOU0NvbG9yAISECE5TT2JqZWN0AIWEAWMBhARmZmZmg0DAJT+DB17vPoM4Y8A8AYY=</data></dict>'
    defaults write com.apple.Terminal "Default Window Settings" "Solarized Light xterm-256color"
    defaults write com.apple.Terminal "Startup Window Settings" "Solarized Light xterm-256color"
  fi
}

function set_defaults() {

  ###############################################################################
  # Screen                                                                      #
  ###############################################################################

  # Require password immediately after sleep or screen saver begins
  defaults write com.apple.screensaver askForPassword -int 1
  defaults write com.apple.screensaver askForPasswordDelay -int 0

  # Save screenshots to the desktop
  defaults write com.apple.screencapture location -string "${HOME}/Desktop"

  # Save screenshots in PNG format (other options: BMP, GIF, JPG, PDF, TIFF)
  defaults write com.apple.screencapture type -string "png"

  ###############################################################################
  # Trackpad                                                                  #
  ###############################################################################

  # Trackpad: enable tap to click for this user and for the login screen
  defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
  defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
  defaults write com.apple.AppleMultitouchTrackpad Clicking -bool true
  defaults write com.apple.AppleMultitouchTrackpad Dragging -bool true
  defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
  defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Dragging -bool true

  # Hot corners
  # Possible values:
  #  0: no-op
  #  2: Mission Control
  #  3: Show application windows
  #  4: Desktop
  #  5: Start screen saver
  #  6: Disable screen saver
  #  7: Dashboard
  # 10: Put display to sleep
  # 11: Launchpad
  # 12: Notification Center
  # Top left screen corner → Mission Control

  defaults write com.apple.dock wvous-tr-corner -int 5

  ###############################################################################
  # SizeUp.app                                                                  #
  ###############################################################################

  # Start SizeUp at login
  defaults write com.irradiatedsoftware.SizeUp StartAtLogin -bool true

  # Don’t show the preferences window on next start
  defaults write com.irradiatedsoftware.SizeUp ShowPrefsOnNextStart -bool false
}

# Main

check_macos_updated
install_brew
install_dotfiles
install_solarized_profiles
set_defaults
install_brew_packages

